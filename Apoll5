#!/bin/bash

# --- Instalador Apollo Engine V5 (Versão Final Pós-Reparação) ---
#
# Este script assume que o Termux está num estado funcional.
# A sua robustez garante que ele verifica cada passo crítico.

# --- Configuração Inicial ---
APOLLO_SOURCE_DIR=~/ApolloEmu
B64D_GIT_URL="https://github.com/Ilya114/Box64Droid.git"

clear
echo "#####################################################"
echo "###                                               ###"
echo "###     Bem-vindo ao Instalador Apollo Engine V5    ###"
echo "###                                               ###"
echo "#####################################################"
read -p "Deseja iniciar a construção final do ApolloEmu? (s/n) " choice
if [ "$choice" != "s" ]; then echo "Operação cancelada."; exit 0; fi

# --- FASE 1: Verificação do Ambiente ---
echo -e "\n[FASE 1/5] A verificar o ambiente Termux..."
pkg update -y > /dev/null # Apenas para garantir
if ! command -v "proot-distro" &> /dev/null; then
    echo "ERRO CRÍTICO: 'proot-distro' não está instalado. Por favor, execute a reparação manual."
    exit 1
fi
echo "Ambiente verificado!"

# --- FASE 2: Instalação da Distro ---
echo -e "\n[FASE 2/5] A verificar o sistema operativo base..."
if [ ! -d "$PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu" ]; then
    echo "A instalar o Ubuntu... (Isto pode demorar MUITO tempo)"
    proot-distro install ubuntu
    if [ $? -ne 0 ]; then
        echo "ERRO CRÍTICO: A instalação da distro falhou. Verifique o seu espaço e conexão."
        exit 1
    fi
else
    echo "O sistema base já está instalado."
fi

# --- FASE 3: Construção e Modificação do Fork ---
echo -e "\n[FASE 3/5] A construir e modificar a base do ApolloEmu..."
rm -rf "$APOLLO_SOURCE_DIR"
git clone --depth=1 "$B64D_GIT_URL" "$APOLLO_SOURCE_DIR"
if [ ! -d "$APOLLO_SOURCE_DIR" ]; then echo "ERRO CRÍTICO: Falha ao descarregar a base."; exit 1; fi

cd "$APOLLO_SOURCE_DIR"
INSTALL_SCRIPT_ORIGINAL="install.sh"
INSTALL_SCRIPT_APOLLO="install-apolloemu.sh"

if [ ! -f "$INSTALL_SCRIPT_ORIGINAL" ]; then echo "ERRO CRÍTICO: A estrutura do repositório mudou."; exit 1; fi

sed -i 's|Box64Droid|ApolloEmu|g' "$INSTALL_SCRIPT_ORIGINAL" README.md
sed -i 's|box64droid|apollo|g' "$INSTALL_SCRIPT_ORIGINAL"
sed -i 's|"startwine"|"start-apolloemu"|g' "$INSTALL_SCRIPT_ORIGINAL"
mv "$INSTALL_SCRIPT_ORIGINAL" "$INSTALL_SCRIPT_APOLLO"
echo "Base modificada com sucesso!"

# --- FASE 4: Instalação Final do ApolloEmu ---
echo -e "\n[FASE 4/5] A instalar o seu novo emulador ApolloEmu..."
chmod +x "$INSTALL_SCRIPT_APOLLO"
./"$INSTALL_SCRIPT_APOLLO"
if [ $? -ne 0 ]; then echo "ERRO CRÍTICO: A instalação do ApolloEmu falhou."; exit 1; fi
echo "O seu emulador foi instalado com sucesso!"

# --- FASE 5: Finalização ---
cd ~
echo -e "\n[FASE 5/5] A limpar ficheiros de construção..."
rm -rf "$APOLLO_SOURCE_DIR"

# --- CONCLUSÃO ---
echo -e "\n\n#############################################"
echo "###           O SEU APOLLOEMU ESTÁ PRONTO!        ###"
echo "#############################################"
echo "\nFeche e reabra o Termux."
echo "\nCOMO JOGAR:"
echo "1. Abra a aplicação Termux:X11."
echo "2. No Termux, execute: start-apolloemu"
